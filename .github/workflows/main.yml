name: ðŸš€ Deploy website on push

on:
  push:
    branches:
      - main
jobs:
  web-deploy:
    name: ðŸŽ‰ Deploy
    runs-on: self-hosted
    steps:
      - name: ðŸšš Get latest code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Deploy to server
        uses: actions/setup-node@v4
        with:
          node-version: "20.11.1"

      - name: ðŸ“¦ Install packages Project
        run: |
          npm install
      - name: ðŸ”¨ Create .env file
        run: |
          echo DATABASE_URL=${{ secrets.DATABASE_URL }} >> .env
          echo NUXT_ACCESS_TOKEN=${{ secrets.NUXT_ACCESS_TOKEN }} >> .env
          echo NUXT_ACCESS_TOKEN_EXP=${{ secrets.NUXT_ACCESS_TOKEN_EXP }} >> .env
          echo NUXT_REFRESH_TOKEN=${{ secrets.NUXT_REFRESH_TOKEN }} >> .env
          echo NUXT_REFRESH_TOKEN_EXP=${{ secrets.NUXT_REFRESH_TOKEN_EXP }} >> .env
          echo NUXT_PUBLIC_SENTRY_DSN=${{ secrets.NUXT_PUBLIC_SENTRY_DSN }} >> .env
          echo NUXT_PUBLIC_ENV=${{ secrets.NUXT_PUBLIC_ENV }} >> .env
      - name: ðŸ”¨ Create ecosystem.config.cjs file
        run: |
          echo "module.exports = {" >> ecosystem.config.cjs
          echo "  apps: [" >> ecosystem.config.cjs
          echo "    {" >> ecosystem.config.cjs
          echo "      name: \"HMS\"," >> ecosystem.config.cjs
          echo "      port: \"3000\"," >> ecosystem.config.cjs
          echo "      exec_mode: \"cluster\"," >> ecosystem.config.cjs
          echo "      instances: \"max\"," >> ecosystem.config.cjs
          echo "      script: \"./.output/server/index.mjs\"," >> ecosystem.config.cjs
          echo "    }," >> ecosystem.config.cjs
          echo "  ]," >> ecosystem.config.cjs
          echo "};" >> ecosystem.config.cjs

      - name: ðŸ”¨ Build Project
        run: |
          npm run build
